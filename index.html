<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ใบลงทะเบียนกิจกรรม</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f4f7f6;
        }
        .form-container {
            background-color: white;
            padding: 2rem;
            max-width: 600px;
            margin: 2rem auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .form-title {
            text-align: center;
            font-weight: 700;
            margin-bottom: 2rem;
            color: #333;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        .form-control, .custom-select {
            border-radius: 8px;
        }
        .form-control:focus, .custom-select:focus {
            box-shadow: 0 0 0 0.2rem rgba(30, 132, 73, 0.25);
            border-color: #1E8449;
        }
        .btn-submit {
            background: linear-gradient(45deg, #1E8449, #28B463);
            border: none;
            border-radius: 50px;
            padding: 12px 30px;
            font-weight: 700;
            color: white;
            width: 100%;
            transition: all 0.3s ease;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 132, 73, 0.3);
        }
        label.required::after {
            content: " *";
            color: red;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="form-container">
        <h3 class="form-title">ใบลงทะเบียนกิจกรรม</h3>

        <form method="post" autocomplete="off" name="data-sheet" id="registerForm">
            <input type="hidden" name="userID" id="userID">
            <input type="hidden" name="profileLine" id="profileLine">

            <div class="form-group">
                <label for="fullName" class="form-label required">ชื่อ-สกุล</label>
                <input type="text" class="form-control" id="fullName" name="ชื่อ-สกุล" required>
            </div>

            <div class="form-group">
                <label for="shopName" class="form-label">ชื่อร้านเสริมสวย/บาร์เบอร์</label>
                <input type="text" class="form-control" id="shopName" name="ชื่อร้านเสริมสวย/บาร์เบอร์">
            </div>

            <div class="form-group">
                <label for="checkin" class="form-label">เช็คอิน</label>
                <input type="text" class="form-control" id="checkin" name="เช็คอิน" placeholder="ระบุสถานที่เช็คอิน">
            </div>

            <div class="form-group">
                <label for="province" class="form-label">จังหวัด</label>
                <select class="custom-select" id="province" name="จังหวัด" required>
                    <option value="">-- กรุณาเลือกจังหวัด --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="district" class="form-label">อำเภอ</label>
                <select class="custom-select" id="district" name="อำเภอ" required>
                    <option value="">-- กรุณาเลือกอำเภอ --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="subdistrict" class="form-label">ตำบล</label>
                <select class="custom-select" id="subdistrict" name="ตำบล" required>
                    <option value="">-- กรุณาเลือกตำบล --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="zipcode" class="form-label">รหัสไปรษณีย์</label>
                <input type="text" class="form-control" id="zipcode" name="รหัสไปรษณีย์" readonly>
            </div>
            
            <div class="form-group">
                <label for="address" class="form-label">บ้านเลขที่</label>
                <input type="text" class="form-control" id="address" name="บ้านเลขที่">
            </div>

            <div class="form-group">
                <label for="phone" class="form-label required">เบอร์โทร</label>
                <input type="tel" class="form-control" id="phone" name="เบอร์โทร" required>
            </div>

            <div class="form-group">
                <label for="age" class="form-label">อายุ</label>
                <input type="number" class="form-control" id="age" name="อายุ">
            </div>
            
            <div class="form-group">
                <label for="status" class="form-label">สถานะ</label>
                <select class="custom-select" id="status" name="สถานะ">
                    <option value="">-- เลือกสถานะ --</option>
                    <option value="ลูกค้า">ลูกค้า</option>
                    <option value="ตัวแทน">ตัวแทน</option>
                    <option value="อื่นๆ">อื่นๆ</option>
                </select>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-submit">บันทึกข้อมูล</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- LIFF Initialization ---
    async function main() {
        await liff.init({ liffId: "2008243853-w5KYZ5oN" }); 
        
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            const profile = await liff.getProfile();
            document.getElementById('userID').value = profile.userId;
            document.getElementById('profileLine').value = profile.displayName; 
        }
    }
    main();

    // --- Form & Sheet Configuration ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwxr2Zn7YQZ-DxTiUyIffRNUFy22ZjuzvSFLe8rYBvNM6DYx0qbhlhesdi95PZw4ONd/exec'; 
    const form = document.forms['data-sheet'];

    // --- Address Data Logic ---
    let addressData = [];
    const provinceSelect = document.getElementById('province');
    const districtSelect = document.getElementById('district');
    const subdistrictSelect = document.getElementById('subdistrict');
    const zipcodeInput = document.getElementById('zipcode');

    // Fetch address data from Google Sheet when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        // Use google.script.run for direct communication with Apps Script
        google.script.run.withSuccessHandler(data => {
            addressData = data;
            populateProvinces();
        }).withFailureHandler(err => {
            console.error('Failed to load address data:', err);
            Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถโหลดข้อมูลที่อยู่ได้', 'error');
        }).getAddressData();
    });

    function populateProvinces() {
        const provinces = [...new Set(addressData.map(row => row[0]))]; // Get unique provinces
        provinces.sort().forEach(province => {
            const option = new Option(province, province);
            provinceSelect.add(option);
        });
    }

    provinceSelect.addEventListener('change', () => {
        // Clear subsequent fields
        districtSelect.innerHTML = '<option value="">-- กรุณาเลือกอำเภอ --</option>';
        subdistrictSelect.innerHTML = '<option value="">-- กรุณาเลือกตำบล --</option>';
        zipcodeInput.value = '';

        const selectedProvince = provinceSelect.value;
        if (!selectedProvince) return;
        
        const districts = [...new Set(
            addressData
                .filter(row => row[0] === selectedProvince)
                .map(row => row[1])
        )];
        
        districts.sort().forEach(district => {
            const option = new Option(district, district);
            districtSelect.add(option);
        });
    });

    districtSelect.addEventListener('change', () => {
        subdistrictSelect.innerHTML = '<option value="">-- กรุณาเลือกตำบล --</option>';
        zipcodeInput.value = '';

        const selectedProvince = provinceSelect.value;
        const selectedDistrict = districtSelect.value;
        if (!selectedDistrict) return;

        const subdistricts = [...new Set(
            addressData
                .filter(row => row[0] === selectedProvince && row[1] === selectedDistrict)
                .map(row => row[2])
        )];
        
        subdistricts.sort().forEach(subdistrict => {
            const option = new Option(subdistrict, subdistrict);
            subdistrictSelect.add(option);
        });
    });
    
    subdistrictSelect.addEventListener('change', () => {
        const selectedProvince = provinceSelect.value;
        const selectedDistrict = districtSelect.value;
        const selectedSubdistrict = subdistrictSelect.value;
        
        const match = addressData.find(row => 
            row[0] === selectedProvince && 
            row[1] === selectedDistrict && 
            row[2] === selectedSubdistrict
        );
        
        zipcodeInput.value = match ? match[3] : '';
    });

    // --- Form Submission ---
    form.addEventListener('submit', e => {
        e.preventDefault();
        
        Swal.fire({
            title: 'กำลังบันทึกข้อมูล...',
            text: 'กรุณารอสักครู่',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });
        
        fetch(scriptURL, { method: 'POST', body: new FormData(form)})
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกข้อมูลสำเร็จ!',
                        showConfirmButton: false,
                        timer: 2000
                    }).then(() => {
                        if(liff.isInClient()) {
                            liff.closeWindow();
                        } else {
                            form.reset();
                            // Reset dropdowns to initial state
                            districtSelect.innerHTML = '<option value="">-- กรุณาเลือกอำเภอ --</option>';
                            subdistrictSelect.innerHTML = '<option value="">-- กรุณาเลือกตำบล --</option>';
                        }
                    });
                } else { throw new Error(data.error); }
            })
            .catch(error => {
                console.error('Error!', error.message);
                Swal.fire('เกิดข้อผิดพลาด!', `ไม่สามารถบันทึกข้อมูลได้`, 'error');
            });
    });
</script>

</body>
</html>
